<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Affiliate App</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { margin: 0; font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7fb; color:#0b1220; }
    header { position: sticky; top: 0; backdrop-filter: saturate(140%) blur(8px); background: rgba(255,255,255,.86); border-bottom: 1px solid #eef0f4; z-index: 10; }
    .wrap { max-width: 1040px; margin: 0 auto; padding: 12px 16px; display: flex; gap: 12px; align-items: center; }
    .logo { width: 32px; height: 32px; border-radius: 10px; display: grid; place-items: center; background: linear-gradient(135deg,#4f46e5,#06b6d4); color:#fff; font-weight: 800; }
    h1 { font-size: 18px; margin: 0; }
    input[type=search] { width: 100%; border: 1px solid #d7dbe2; border-radius: 12px; padding: 10px 12px; }
    main { max-width: 1040px; margin: 0 auto; padding: 16px; }
    .hint { color:#3b3f49; background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:12px 14px; font-size: 14px; box-shadow:0 6px 18px rgba(0,0,0,.05) }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(110px,1fr)); gap: 14px; }
    .tile { background:#fff; border-radius: 22px; padding: 14px 10px; box-shadow: 0 8px 26px rgba(0,0,0,.07); display:flex; flex-direction:column; align-items:center; gap: 10px; min-height: 150px; }
    .tile:hover { box-shadow: 0 10px 34px rgba(0,0,0,.10); }
    .app-icon { width: 64px; height: 64px; border-radius: 14px; background:#fff; border:1px solid #e5e7eb; display:grid; place-items:center; overflow:hidden }
    .app-icon img { width: 60px; height: 60px; object-fit: contain }
    .name { font-weight: 650; font-size: 14px; text-align:center }
    .muted { color:#6b7280; font-size: 12px; text-align:center }
    .section { margin: 22px 0 8px; font-weight: 600; color:#0b1220; }
    button.link { appearance: none; border: 0; background: transparent; text-align: left; padding: 0; cursor: pointer; }
    footer { color:#6b7280; font-size: 12px; padding: 28px 16px 60px; max-width:1040px; margin:0 auto; }
    .btn { appearance:none; border:1px solid #d7dbe2; background:#2563eb; color:#fff; border-radius:12px; padding:8px 12px; font-weight:600; cursor:pointer }
    .btn:hover{ box-shadow:0 6px 16px rgba(0,0,0,.06) }

    @media (prefers-color-scheme: dark) {
      body { background: #0b1220; color: #e6e7ea; }
      header { background: rgba(14,18,28,.7); border-bottom-color: #1c2333; }
      .hint { background:#0e1422; border-color:#28324a; color:#cbd5e1 }
      .tile { background: #131a2a; box-shadow: 0 8px 26px rgba(0,0,0,.5); }
      input[type=search] { background:#0e1422; color:#e6e7ea; border-color:#28324a; }
      .app-icon { background:#1b2240; }
      .muted { color:#9aa3b2; }
      .btn { border-color:#3b82f6; background:#3b82f6; color:#0b1220 }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="logo" aria-hidden="true">A</div>
      <h1>Affiliate App</h1>
      <div style="margin-left:auto; flex:1; max-width: 460px;">
        <input id="q" type="search" placeholder="Search partners, categories…" aria-label="Search partners" />
      </div>
    </div>
  </header>

  <main>
    <div class="hint" id="instructions">
      <strong>Make this your "All-Apps" launcher:</strong>
      Open this page on your phone, then <em>Add to Home Screen</em>. Use this as your main app to access all your other apps via your affiliate links. iPhone (Safari): Share → Add to Home Screen. Android (Chrome): ⋮ menu → Install app / Add to Home Screen.
    </div>

    <div id="catalog" style="margin-top:14px;"></div>
  </main>

  <footer>
    Affiliate destinations always open on the network (no WebViews), so tracking and deep links work.
  </footer>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const supabaseUrl = "https://pvfxettbmykvezwahohh.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2ZnhldHRibXlrdmV6d2Fob2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NTc2MzMsImV4cCI6MjA3MjMzMzYzM30.M5V-N3jYDs1Eijqb6ZjscNfEOSMMARe8HI20sRdAOTQ";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // =============== UTILS ===============
    function openAffiliate(url){
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // =============== RENDER ===============
    function render(apps){
  const host = document.getElementById("catalog");
  host.innerHTML = "";

  if (!apps.length){
    host.innerHTML = `<p class="muted">No apps available.</p>`;
    return;
  }

  const grid = document.createElement("div");
  grid.className = "grid";

  apps.forEach(app=>{
    const card = document.createElement("button");
    card.className = "tile link";
    card.onclick = ()=>openAffiliate(app.href);

    card.innerHTML = `
      <div class="app-icon"><img src="${app.logo_url || app.icon_url || ''}" alt=""></div>
      <div class="name">${app.name}</div>
      <div class="muted">${app.description || ''}</div>
    `;
    grid.appendChild(card);
  });

  host.appendChild(grid);
}

    // =============== LOAD APPS ===============
    async function loadUserApps(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return [];

      const { data, error } = await supabase
        .from("user_apps")
        .select("apps(id, name, href, description, logo_url, icon_url, folder)")
        .eq("user_id", user.id);

      if(error){ console.error(error); return []; }
      return data.map(d=>d.apps);
    }

    async function loadDefaultApps(){
      const { data, error } = await supabase
        .from("apps")
        .select("id, name, href, description, logo_url, icon_url, folder")
        .eq("is_default", true);

      if(error){ console.error(error); return []; }
      return data;
    }

    // =============== INIT ===============
    async function init(){
      const defaults = await loadDefaultApps();
      const userApps = await loadUserApps();
      const all = [...defaults, ...userApps];
      render(all);
    }

    init();
  </script>
</body>
</html>


