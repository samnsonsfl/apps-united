<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Affiliate App</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- App Icons -->
  <link rel="icon" type="image/x-icon" href="favicon2.ico">
  <link rel="apple-touch-icon" sizes="192x192" href="app-store-192x192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="app-store-512x512.png">

  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { margin: 0; font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7fb; color:#0b1220; }
    header { position: sticky; top: 0; backdrop-filter: saturate(140%) blur(8px); background: rgba(255,255,255,.86); border-bottom: 1px solid #eef0f4; z-index: 10; }
    .wrap { max-width: 1040px; margin: 0 auto; padding: 12px 16px; display: flex; gap: 12px; align-items: center; }
    h1 { font-size: 48px; margin: 0; }
    input[type=search] { width: 100%; border: 1px solid #d7dbe2; border-radius: 12px; padding: 10px 12px; }
    main { max-width: 1040px; margin: 0 auto; padding: 16px; }
    .hint { color:#3b3f49; background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:12px 14px; font-size: 14px; box-shadow:0 6px 18px rgba(0,0,0,.05) }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .tile { background:#fff; border-radius: 22px; padding: 14px 10px; box-shadow: 0 8px 26px rgba(0,0,0,.07); display:flex; flex-direction:column; align-items:center; gap: 10px; min-height: 150px; position: relative; cursor:pointer; }
    .tile:hover { box-shadow: 0 10px 34px rgba(0,0,0,.10); }
    .app-icon { width: 128px; height: 128px; border-radius: 14px; background:#fff; border:4px solid #e5e7eb; display:grid; place-items:center; overflow:hidden }
    .app-icon img { width: 120px; height: 120px; object-fit: contain }
    .name { font-weight: 650; font-size: 28px; text-align:center }
    .muted { color:#6b7280; font-size: 24px; text-align:center }
    .section { margin: 22px 0 8px; font-weight: 600; color:#0b1220; }
    button.link { appearance: none; border: 0; background: transparent; text-align: left; padding: 0; cursor: pointer; }
    footer { color:#6b7280; font-size: 12px; padding: 28px 16px 60px; max-width:1040px; margin:0 auto; }
    .btn { appearance:none; border:1px solid #d7dbe2; background:#2563eb; color:#fff; border-radius:12px; padding:8px 12px; font-weight:600; cursor:pointer }
    .btn:hover{ box-shadow:0 6px 16px rgba(0,0,0,.06) }
    .remove-btn {
      position: absolute; top: 6px; right: 6px;
      background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%;
      width: 20px; height: 20px; font-size: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .remove-btn:hover { background: rgba(220,38,38,0.85); }
    .main-logo, .store-logo { width: 75px; height: 75px; border-radius: 5px; object-fit: contain; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .store-btn { border: none; background: transparent; cursor: pointer; margin-left: 12px; display: flex; align-items: center; }

    /* External Tab Bar (no iframes) */
    .tabs-wrap { margin-top: 12px; border:1px solid #e5e7eb; border-radius:14px; background:#fff; box-shadow:0 8px 26px rgba(0,0,0,.07); overflow:hidden; display:none; }
    .tab-bar { display:flex; gap:6px; align-items:center; padding:8px; border-bottom:1px solid #eef0f4; overflow:auto; }
    .tab { display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; background:#f3f4f6; cursor:pointer; white-space:nowrap; }
    .tab.active { background:#dbeafe; }
    .tab img { width:18px; height:18px; border-radius:4px; object-fit:contain; }
    .tab .kind { font-size:12px; opacity:.7; }
    .tab .close { border:none; background:transparent; font-size:16px; line-height:1; cursor:pointer; opacity:.7; }
    .tab .close:hover { opacity:1; }
    .tab-spacer { flex:1; }
    .bar-btn { margin-left:6px; }

    /* Toast */
    .toast { position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; box-shadow:0 6px 16px rgba(0,0,0,.2); opacity:0; pointer-events:none; transition:opacity .25s; z-index: 50; }
    .toast.show { opacity:1; }

    /* Recents header */
    .row-head { display:flex; justify-content:space-between; align-items:center; margin: 26px 0 8px; }

    @media (prefers-color-scheme: dark) {
      body { background: #0b1220; color: #e6e7ea; }
      header { background: rgba(14,18,28,.7); border-bottom-color: #1c2333; }
      .hint { background:#0e1422; border-color:#28324a; color:#cbd5e1 }
      .tile { background: #131a2a; box-shadow: 0 8px 26px rgba(0,0,0,.5); }
      input[type=search] { background:#0e1422; color:#e6e7ea; border-color:#28324a; }
      .app-icon { background:#1b2240; }
      .muted { color:#9aa3b2; }
      .btn { border-color:#3b82f6; background:#3b82f6; color:#0b1220 }

      .tabs-wrap { background:#131a2a; border-color:#28324a; }
      .tab-bar { border-bottom-color:#28324a; }
      .tab { background:#0e1422; }
      .tab.active { background:#1e293b; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <img src="favicon-192.png" alt="Apps United Logo" class="main-logo">
      <h1>Apps United</h1>
      <div style="margin-left:auto; flex:1; max-width: 460px;">
        <input id="q" type="search" placeholder="Search partners, categories…" aria-label="Search partners" />
      </div>
      <button id="storeBtn" class="store-btn" title="Open App Store">
        <img src="app-store-192x192.png" alt="App Store" class="store-logo">
      </button>
    </div>
  </header>

  <main>
    <div class="hint" id="instructions">
      <p style="margin:0; font-size:14px;">
        <strong>Make this your "Apps-Hub" launcher:</strong>
        <span id="moreText" style="display:none;">
          Open this page on your phone, then <em>Add to Home Screen</em>. Use this as your main app 
          to access all your other apps via your affiliate links. 
          iPhone (Safari): Share → Add to Home Screen. 
          Android (Chrome): ⋮ menu → Install app / Add to Home Screen.
        </span>
        <a href="javascript:void(0);" id="readMoreBtn">read more</a>
      </p>
    </div>

    <script>
      const btn = document.getElementById("readMoreBtn");
      const moreText = document.getElementById("moreText");
      btn.addEventListener("click", () => {
        if (moreText.style.display === "none") {
          moreText.style.display = "inline";
          btn.textContent = "read less";
        } else {
          moreText.style.display = "none";
          btn.textContent = "read more";
        }
      });
    </script>

    <!-- External Tabs (no iframes) -->
    <div class="tabs-wrap" id="tabsWrap">
      <div class="tab-bar" id="tabBar">
        <!-- tabs injected -->
        <div class="tab-spacer"></div>
        <button class="btn bar-btn" id="focusBtn" type="button" title="Focus current tab">Focus</button>
        <button class="btn bar-btn" id="closeAllBtn" type="button" title="Close all tabs">Close all</button>
      </div>
    </div>

    <!-- App catalog -->
    <div id="catalog" style="margin-top:14px;"></div>

    <!-- Recently opened -->
    <div id="recents-section" style="margin-top:8px;">
      <div class="row-head">
        <div class="section" style="margin:0;">RECENTLY OPENED</div>
        <button class="btn" id="clearRecentsBtn" type="button" title="Clear recently opened">Clear</button>
      </div>
      <div id="recent-list" class="grid"></div>
    </div>
  </main>

  <footer>
    <div>Affiliate destinations always open on the network (no WebViews), so tracking and deep links work.</div>
    <p style="text-align:center; font-size:14px; margin-top:10px;">
      © <script>document.write(new Date().getFullYear());</script> Apps United ·
      <a href="/legal/privacy.md" target="_blank" style="color:#2563eb; text-decoration:none;">Privacy Policy</a> ·
      <a href="/legal/terms.md" target="_blank" style="color:#2563eb; text-decoration:none;">Terms of Service</a> ·
      <a href="/legal/account-deletion.md" target="_blank" style="color:#2563eb; text-decoration:none;">Account Deletion</a>
    </p>
  </footer>

  <div id="toast" class="toast"></div>

  <!-- ✅ Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://pvfxettbmykvezwahohh.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2ZnhldHRibXlrdmV6d2Fob2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NTc2MzMsImV4cCI6MjA3MjMzMzYzM30.M5V-N3jYDs1Eijqb6ZjscNfEOSMMARe8HI20sRdAOTQ";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    /* ============
       Tiny helpers
       ============ */
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    function toast(msg, ms=2600){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), ms); }
    function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

    // Stable window name per app so we can refocus without navigation (no reset)
    function windowNameFor(app) {
      const base = (app.name || app.href || 'app').toLowerCase().replace(/[^a-z0-9]+/g, '_').slice(0, 40);
      return `au_tab_${base}`;
    }

    /* ======================
       Recents (localStorage)
       ====================== */
    const RECENTS_KEY = "au_recent_apps";
    const MAX_RECENTS = 15;

    function getRecents() {
      try { return JSON.parse(localStorage.getItem(RECENTS_KEY) || "[]"); }
      catch { return []; }
    }
    function saveRecents(list) { localStorage.setItem(RECENTS_KEY, JSON.stringify(list)); }
    function addToRecents(app) {
      const recents = getRecents();
      const i = recents.findIndex(r => r.href === app.href);
      if (i !== -1) recents.splice(i, 1);
      recents.unshift({ name: app.name, href: app.href, icon: app.logo_url || app.icon_url || "", ts: Date.now() });
      if (recents.length > MAX_RECENTS) recents.length = MAX_RECENTS;
      saveRecents(recents);
      renderRecents();
    }
    function clearRecents() { saveRecents([]); renderRecents(); }
    function renderRecents() {
      const host = $("#recent-list");
      const recents = getRecents();
      if (!recents.length) {
        host.innerHTML = `<p class="muted" style="grid-column: 1/-1; text-align:center;">No recent apps yet.</p>`;
        return;
      }
      host.innerHTML = recents.map(r => `
        <div class="tile" onclick='openApp({name:${JSON.stringify(r.name)}, href:${JSON.stringify(r.href)}, logo_url:${JSON.stringify(r.icon)}})'>
          <div class="app-icon"><img src="${r.icon}" alt=""></div>
          <div class="name">${r.name}</div>
          <div class="muted">Recently opened</div>
        </div>
      `).join("");
    }
    $("#clearRecentsBtn").addEventListener("click", clearRecents);

    /* ============
       External Tab Manager (named windows)
       ============ */
    // Model: { id, name, href, icon, win?, windowName }
    let openTabs = [];
    let activeTabId = null;

    const tabsWrap = $("#tabsWrap");
    const tabBar   = $("#tabBar");

    $("#closeAllBtn").addEventListener("click", () => {
      openTabs.forEach(t => { if (t.win && !t.win.closed) try { t.win.close(); } catch {} });
      openTabs = [];
      activeTabId = null;
      $$(".tab", tabBar).forEach(el => el.remove());
      tabsWrap.style.display = "none";
    });

    $("#focusBtn").addEventListener("click", () => {
      const t = openTabs.find(x => x.id === activeTabId);
      if (!t) return;
      focusOrReopen(t);
    });

    function addTabButton(t) {
      const tab = document.createElement("div");
      tab.className = "tab";
      tab.dataset.id = t.id;
      tab.innerHTML = `
        ${t.icon ? `<img src="${t.icon}" alt="">` : ""}
        <span class="title">${t.name}</span>
        <span class="kind">↗</span>
        <button class="close" title="Close tab" aria-label="Close">×</button>
      `;
      tab.querySelector(".close").addEventListener("click", (e) => { e.stopPropagation(); closeTab(t.id); });
      tab.addEventListener("click", () => activateTab(t.id));
      tabBar.insertBefore(tab, tabBar.querySelector(".tab-spacer"));
      return tab;
    }

    function activateTab(id) {
      activeTabId = id;
      $$(".tab", tabBar).forEach(el => el.classList.toggle("active", el.dataset.id === id));
      tabsWrap.style.display = openTabs.length ? "block" : "none";
      const t = openTabs.find(x => x.id === id);
      if (t) focusOrReopen(t); // bring it to front without navigating
    }

    function closeTab(id) {
      const idx = openTabs.findIndex(t => t.id === id);
      if (idx === -1) return;
      const t = openTabs[idx];
      // Try to close the window (works reliably if we opened it)
      if (t.win && !t.win.closed) { try { t.win.close(); } catch {} }
      tabBar.querySelector(`.tab[data-id="${id}"]`)?.remove();
      openTabs.splice(idx, 1);
      if (activeTabId === id) {
        if (openTabs[idx]) activateTab(openTabs[idx].id);
        else if (openTabs[idx - 1]) activateTab(openTabs[idx - 1].id);
        else { activeTabId = null; tabsWrap.style.display = openTabs.length ? "block" : "none"; }
      }
      if (!openTabs.length) tabsWrap.style.display = "none";
    }

    // Focus existing named window without navigating; if gone or blank, fix it
    function focusOrReopen(t) {
      const name = t.windowName || windowNameFor(t);
      let w = null;

      try {
        // '' -> attach to existing named window *without navigating*
        w = window.open('', name);
      } catch {}

      if (w && !w.closed) {
        t.win = w;
        try {
          // If browser returned a brand-new about:blank, navigate it to saved URL
          const looksBlank = (w.location && w.location.href === 'about:blank');
          const noHistory  = (typeof w.history?.length === 'number' ? w.history.length === 0 : true);
          if (looksBlank && noHistory) {
            w.location.assign(t.href);
          }
        } catch {
          // Cross-origin check can throw; still try to focus.
        }
        try { w.focus(); } catch {}
        return;
      }

      // Couldn't attach -> open fresh with stable name
      t.win = window.open(t.href, name);
      t.windowName = name;
      if (!t.win) toast("Your browser blocked the new tab. Allow pop-ups for this site.");
    }

    // Open (or reuse) a named tab for this app and add it to our tab strip
    function openExternalManaged(app) {
      const windowName = windowNameFor(app);

      // Already have a tab for this app? Reuse its window name and focus.
      let existing = openTabs.find(x => x.windowName === windowName) 
                  || openTabs.find(x => x.href === app.href);

      if (existing) {
        existing.windowName = windowName; // ensure latest stable name
        activateTab(existing.id);         // will call focusOrReopen(existing)
        return;
      }

      // First time: open named window so future activates don't navigate.
      // IMPORTANT: do not use "noopener" here; we keep a handle for focus/close.
      const win = window.open(app.href, windowName);
      if (!win) toast("Your browser blocked the new tab. Allow pop-ups for this site.");

      const t = {
        id: uid(),
        name: app.name,
        href: app.href,
        icon: app.logo_url || app.icon_url || "",
        win,
        windowName
      };
      addTabButton(t);
      openTabs.push(t);
      activateTab(t.id);
    }

    function openApp(app) {
      addToRecents(app);
      openExternalManaged(app);
    }

    /* =========
       Catalog
       ========= */
    function render(apps){
      const host = document.getElementById("catalog");
      host.innerHTML = "";

      if (!apps.length){
        host.innerHTML = `<p class="muted">No apps available.</p>`;
        return;
      }

      const categories = {};
      apps.forEach(app => {
        const cat = app.folder && app.folder.trim() ? app.folder : "Uncategorized";
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(app);
      });

      const sortedCategories = Object.keys(categories).sort();

      sortedCategories.forEach(cat => {
        const section = document.createElement("div");
        section.className = "category-section";

        const heading = document.createElement("div");
        heading.className = "section";
        heading.textContent = cat.toUpperCase();
        heading.style.background = "white";
        heading.style.padding = "6px";
        section.appendChild(heading);

        const grid = document.createElement("div");
        grid.className = "grid collapsed";

        categories[cat].sort((a, b) => a.name.localeCompare(b.name));

        categories[cat].forEach(app => {
          const card = document.createElement("div");
          card.className = "tile";
          card.innerHTML = `
            <button class="remove-btn" title="Remove app">×</button>
            <div class="app-icon"><img src="${app.logo_url || app.icon_url || ''}" alt=""></div>
            <div class="name">${app.name}</div>
            <div class="muted">${app.description || ''}</div>
          `;
          // open externally (managed, named window)
          card.addEventListener("click", (e) => {
            if (e.target.closest(".remove-btn")) return;
            openApp(app);
          });
          // remove
          card.querySelector(".remove-btn").onclick = (e)=>{ e.stopPropagation(); removeApp(app.id); };
          grid.appendChild(card);
        });

        section.appendChild(grid);

        if (categories[cat].length > 5) {
          const toggle = document.createElement("button");
          toggle.textContent = "Show more";
          toggle.className = "collapse-btn";
          toggle.onclick = () => {
            grid.classList.toggle("collapsed");
            toggle.textContent = grid.classList.contains("collapsed") ? "Show more" : "Show less";
          };
          section.appendChild(toggle);
        }
        document.getElementById("catalog").appendChild(section);
      });
    }

    async function loadUserApps(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return [];
      const { data, error } = await supabase
        .from("user_apps")
        .select("apps(id, name, href, description, logo_url, icon_url, folder)")
        .eq("user_id", user.id);
      if(error){ console.error(error); return []; }
      return data.map(d=>d.apps);
    }

    async function loadDefaultApps(){
      const { data, error } = await supabase
        .from("apps")
        .select("id, name, href, description, logo_url, icon_url, folder")
        .eq("is_default", true);
      if(error){ console.error(error); return []; }
      return data;
    }

    async function init(){
      const defaults = await loadDefaultApps();
      const userApps = await loadUserApps();
      render([...defaults, ...userApps]);
      renderRecents();
      $("#tabsWrap").style.display = "none"; // shows after first open
    }

    init();

    async function removeApp(appId){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { alert("You must be logged in."); return; }
      const { error } = await supabase
        .from("user_apps")
        .delete()
        .eq("user_id", user.id)
        .eq("app_id", appId);
      if(error){ console.error(error); alert("Error removing app."); }
      else { init(); }
    }

    document.getElementById("storeBtn").addEventListener("click", () => {
      window.location.href = "store.html";
    });
  </script>
</body>
</html>
