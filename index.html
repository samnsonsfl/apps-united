<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Add App — Affiliate App</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#f6f7fb; color:#0b1220 }
    .wrap { max-width:720px; margin:0 auto; padding:20px 16px }
    h1 { font-size:20px; margin:0 0 12px }
    form { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.05) }
    label { display:block; font-weight:600; font-size:14px; margin:10px 0 6px }
    input, textarea { width:100%; border:1px solid #d7dbe2; border-radius:12px; padding:10px 12px; font:inherit }
    textarea { min-height:80px }
    .hint { color:#6b7280; font-size:12px; margin-top:4px }
    .btn { appearance:none; border:1px solid #2563eb; background:#2563eb; color:#fff; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer }
    .btn.sec { background:#fff; color:#2563eb }
    .actions { display:flex; gap:12px; margin-top:16px }
    .ok { margin-top:14px; padding:12px; border-radius:12px; background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; display:none }
    a { color:#2563eb; text-decoration:none }
    @media (prefers-color-scheme: dark){
      body { background:#0b1220; color:#e6e7ea }
      form { background:#131a2a; border-color:#28324a }
      input,textarea { background:#0e1422; border-color:#28324a; color:#e6e7ea }
      .btn { border-color:#3b82f6; background:#3b82f6; color:#0b1220 }
      .btn.sec { background:transparent; color:#8ab4ff; border-color:#28324a }
      .ok { background:#052e2b; color:#d1fae5; border-color:#065f46 }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Add App</h1>
    <p class="hint">Tip: If you leave “Logo URL” empty and your logo registry has a matching key, the logo will auto-fill.</p>

    <!-- IMPORTANT: action="javascript:void(0)" ensures no real form POST even if JS is blocked -->
    <form id="addForm" action="javascript:void(0)">
      <label>App name</label>
      <input id="name" placeholder="e.g., Marriott" required />

      <label>Affiliate link (full https URL)</label>
      <input id="url" placeholder="https://www.marriott.com/...?affiliate=..." required />

      <div class="row">
        <label>Category <span class="hint">(optional)</span></label>
        <input id="category" placeholder="Hotels, Flights, Everything…" />
      </div>

      <div class="row">
        <label>Logo URL <span class="hint">(optional — leave blank to auto-use from registry if available)</span></label>
        <input id="logo" placeholder="https://dl.dropboxusercontent.com/.../marriott.jpeg" />
      </div>

      <label>Short caption <span class="hint">(optional)</span></label>
      <textarea id="desc" placeholder="Book stays worldwide."></textarea>

      <div class="actions">
        <button type="submit" class="btn">Save App</button>
        <a class="btn sec" href="https://www.twoticketsonebag.com/store/affiliate-app/">Cancel</a>
      </div>

      <div id="ok" class="ok">
        Saved! <a id="backLink" href="https://www.twoticketsonebag.com/store/affiliate-app/">Return to the launcher</a>.
      </div>
    </form>
  </div>

  <script>
    // Where to go after saving:
    const REDIRECT_URL = 'https://www.twoticketsonebag.com/store/affiliate-app/';

    // Same storage keys as the main page
    const STORAGE_KEYS = {
      partners:'affiliate_apps_v1',
      registry:'logo_registry_url_v1',
      registryCache:'logo_registry_cache_v1',
    };

    const slug = (s='') => s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

    function normalizeDropbox(url=''){
      try {
        if (!url) return '';
        const u = new URL(url);
        if (u.hostname.includes('dropbox.com')) {
          u.hostname = 'dl.dropboxusercontent.com';
          const params = new URLSearchParams(u.search);
          if (!params.has('raw') && !params.has('dl')) params.set('raw','1');
          u.search = params.toString() ? `?${params.toString()}` : '';
          return u.toString();
        }
        return url;
      } catch { return url; }
    }

    // Load logo registry (same as main page)
    let logoRegistry = {};
    async function loadRegistry(){
      const LOGO_REGISTRY_URL = localStorage.getItem(STORAGE_KEYS.registry) || 'https://api.jsonbin.io/v3/b/68b22be843b1c97be92fc6a0/latest?meta=false';
      try {
        const cached = JSON.parse(localStorage.getItem(STORAGE_KEYS.registryCache) || 'null');
        const now = Date.now();
        if (cached && (now - cached.time < 24*60*60*1000) && cached.url === LOGO_REGISTRY_URL) {
          logoRegistry = cached.map || {};
          return;
        }
        const res = await fetch(LOGO_REGISTRY_URL);
        const txt = await res.text();
        const data = JSON.parse(txt);
        const map = {};
        Object.keys(data||{}).forEach(k => { map[slug(k)] = normalizeDropbox(String(data[k]||'')); });
        logoRegistry = map;
        localStorage.setItem(STORAGE_KEYS.registryCache, JSON.stringify({ url: LOGO_REGISTRY_URL, time: now, map }));
      } catch(e){ console.warn('Registry load error', e); }
    }

    function getPartners(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.partners)) || []; } catch { return []; } }
    function savePartners(list){ localStorage.setItem(STORAGE_KEYS.partners, JSON.stringify(list)); }

    function pickLogo(nameOrId, provided){
      if (provided) return normalizeDropbox(provided);
      const key = slug(nameOrId);
      return logoRegistry[key] || '';
    }

    document.getElementById('addForm').addEventListener('submit', async (e) => {
      // never allow a real POST
      e.preventDefault();

      // make sure registry is available (for auto logo)
      await loadRegistry();

      const name = document.getElementById('name').value.trim();
      const url  = document.getElementById('url').value.trim();
      const category = (document.getElementById('category').value.trim() || 'Other');
      const logoInput = document.getElementById('logo').value.trim();
      const desc = document.getElementById('desc').value.trim();

      if (!name || !/^https?:\/\//i.test(url)) { alert('Please enter a valid name and https URL.'); return; }

      const id = slug(name);
      const partners = getPartners();
      if (partners.some(p => p.id === id)) {
        // already exists → just go back
        window.top ? window.top.location.assign(REDIRECT_URL) : window.location.assign(REDIRECT_URL);
        return;
      }

      const logo = pickLogo(id, logoInput);
      const entry = { id, name, url, category, logo, desc };
      const next = [...partners, entry].sort((a,b)=>a.name.localeCompare(b.name));
      savePartners(next);

      // Redirect robustly; if blocked (iframe), show a success link instead
      try {
        window.top ? window.top.location.replace(REDIRECT_URL) : window.location.replace(REDIRECT_URL);
      } catch (_) {
        document.getElementById('ok').style.display = 'block';
        document.getElementById('backLink').href = REDIRECT_URL;
      }
    });
  </script>
</body>
</html>

